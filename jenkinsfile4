pipeline {
    agent any
    environment {
        BLUE_SERVER = "54.242.239.106"
        GREEN_SERVER = "98.93.30.214"
        REMOTE_PATH = "/var/www/html/index.html"
        LOCAL_WORKSPACE_FILE = "${env.WORKSPACE}/index.html"
        ALB_LISTENER_ARN = "arn:aws:elasticloadbalancing:us-east-1:123456789012:listener/app/my-alb/789abc/123def"
        BLUE_TG_ARN = "arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/blue-tg/abc123"
        GREEN_TG_ARN = "arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/green-tg/def456"
    }
    stages {
        stage('Checkout SCM') {
            steps {
                echo "Checking out source code..."
                git(
                    url: 'https://github.com/Zeeshancloud15/jenkins-ecr.git',
                    credentialsId: 'blue-green-ssh',
                    branch: 'main'
                )
            }
        }

        stage('Prepare index.html') {
            steps {
                echo "Pulling index.html from BLUE server..."
                sshagent(['blue-green-ssh']) {
                    sh "scp -o StrictHostKeyChecking=no jenkins@${BLUE_SERVER}:${REMOTE_PATH} ${LOCAL_WORKSPACE_FILE}"
                }
            }
        }

        stage('Deploy to GREEN') {
            steps {
                echo "Deploying index.html to GREEN server..."
                sshagent(['blue-green-ssh']) {
                    // Use sudo if permission denied
                    sh """
                    scp -o StrictHostKeyChecking=no ${LOCAL_WORKSPACE_FILE} jenkins@${GREEN_SERVER}:${REMOTE_PATH} || \
                    ssh -o StrictHostKeyChecking=no jenkins@${GREEN_SERVER} 'sudo cp ${REMOTE_PATH} ${REMOTE_PATH}'
                    """
                }
            }
        }

        stage('Health Check') {
            steps {
                echo "Checking GREEN server health..."
                sshagent(['blue-green-ssh']) {
                    script {
                        def status = sh(script: "ssh -o StrictHostKeyChecking=no jenkins@${GREEN_SERVER} curl -s -o /dev/null -w '%{http_code}' http://localhost/index.html", returnStdout: true).trim()
                        echo "HTTP Status: ${status}"
                        if (status != "200") {
                            error "GREEN server health check failed!"
                        }
                    }
                }
            }
        }

        stage('Switch Traffic to GREEN') {
            steps {
                echo "Switching traffic to GREEN target group..."
                sh """
                aws elbv2 modify-listener --listener-arn ${ALB_LISTENER_ARN} --default-actions Type=forward,TargetGroupArn=${GREEN_TG_ARN}
                """
            }
        }
    }

    post {
        failure {
            echo "Deployment failed! Rolling back to BLUE..."
            sh """
            aws elbv2 modify-listener --listener-arn ${ALB_LISTENER_ARN} --default-actions Type=forward,TargetGroupArn=${BLUE_TG_ARN}
            """
        }
    }
}
